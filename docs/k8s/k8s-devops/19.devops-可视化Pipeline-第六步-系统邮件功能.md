# 19.devops-可视化Pipeline-第六步-系统邮件功能



​		我们之前针对微服务在部署期间有些比较奇怪的问题，我们必须把这个微服务先访问一下，然后把他激活了以后，我们的就绪 探针才可以生效

​		而针对于这个问题是我们spring这个低版本，我们使用的是2.2.1的版本

![1657611141309](../../.vuepress/public/images/1657611141309.png)



​		我们更推荐使用springboot的 2.4.* 或者是 2.3.*这样的话，对于我们和k8s的整合就会更好一些



​		在低版本2.2.1中，我们选择把这个就绪探针注掉，这样的话就是下次应用启动成功就是成功了，不用探针探测了，要么还得激活一下，也比较麻烦

![1657611371913](../../.vuepress/public/images/1657611371913.png)

​			我们针对于这个奇怪的问题就先这么解决



​		我们现在这些都做完之后，我们再在流水线上扩展一些事情



​	我们的流水线--在真正做完后，我们期望是在最后的一步--比如人工卡点啊 邮件发送等步骤

![1657611515299](../../.vuepress/public/images/1657611515299.png)





​	我们现在是加入一个邮件的功能



#### 流水线邮件发送功能

![1657611647396](../../.vuepress/public/images/1657611647396.png)



​		选择邮件

![1657611674066](../../.vuepress/public/images/1657611674066.png)



​	然后填写邮件信息，在body中填写内容，当然在这里也可以使用$符号取出我们之前配置的环境变量的信息

![1657611809134](../../.vuepress/public/images/1657611809134.png)



​	我们放到本地编辑一下---我们使用构建的次数变量-构建结果

![1657611932280](../../.vuepress/public/images/1657611932280.png)



​	

​	我们想要发送邮件那么，系统就需要拥有发邮件的功能，需要我们登录到系统中配置一下这个邮件的功能

​		使用admin登录

![1657612032445](../../.vuepress/public/images/1657612032445.png)



​	然后是平台管理------集群管理，不对，到平台设置中

![1657612066212](../../.vuepress/public/images/1657612066212.png)



​	



​		在这里需要配置邮件服务器的地址，邮件服务器的用户名及密码

![1657612176313](../../.vuepress/public/images/1657612176313.png)





​	我们进入到网易邮箱的邮件发送服务设置中

![1657612262868](../../.vuepress/public/images/1657612262868.png)





​		我们使用这个SMTP服务器，拷贝smtp.163.com

![1657612313999](../../.vuepress/public/images/1657612313999.png)



​		而账号和密码---我们需要开启一下这个邮件服务

![1657612377782](../../.vuepress/public/images/1657612377782.png)





​	这个开启后的授权码---其实就是我们登录到邮件服务器的密码

![1657612447845](../../.vuepress/public/images/1657612447845.png)



​	账户--其实就是我们使用的邮件账户---然后保存--我们的邮件服务就配置好了

![1657612600162](../../.vuepress/public/images/1657612600162.png)



​		我们这个配置好了之后---以后我们凡事需要发送邮件的，我们的平台就会以这个邮件服务进行邮件的推送





​	我们创建一个简单的流水线--专门测试这个邮件的服务

![1657612713351](../../.vuepress/public/images/1657612713351.png)





​	然后添加一个邮件功能的流水线步骤

![1657612803966](../../.vuepress/public/images/1657612803966.png)

![1657612814417](../../.vuepress/public/images/1657612814417.png)





​		运行流水线：

![1657612848636](../../.vuepress/public/images/1657612848636.png)



​	运行的流水线我们发现失败了

![1657612903998](../../.vuepress/public/images/1657612903998.png)



​    原因是这里使用的mail.example.com这个邮箱

![1657612981643](../../.vuepress/public/images/1657612981643.png)



​	邮件是配好了全局的邮件，但是对于流水线使用的邮件我们还需要单独配置一下，我们到官网上查看一下

![1657613131524](../../.vuepress/public/images/1657613131524.png)





​	在应用负载--工作负载--kubesphere-devops-system项目中，编辑yaml配置文件

![1657613309257](../../.vuepress/public/images/1657613309257.png)





​		我们看到这些配置是和邮件相关的配置

![1657613361714](../../.vuepress/public/images/1657613361714.png)





​		我们查看一下邮件服务的端口 ssl和非ssl使用的端口是不一样的这个需要注意下

![1657613643173](../../.vuepress/public/images/1657613643173.png)



​		

​		然后我们配置这个jenkins的配置文件，配置好保存更新

![1657613728909](../../.vuepress/public/images/1657613728909.png)





​		我们重新运行一下这个邮件的流水线

​			这个流水线的服务运行成功

![1657613901519](../../.vuepress/public/images/1657613901519.png)





​	我们进入网易邮箱查看一下是否收到了邮件通知

![1657613944744](../../.vuepress/public/images/1657613944744.png)





​	没有问题--只不过是我们的动态变量的值没有取出来

![1657613984326](../../.vuepress/public/images/1657613984326.png)





​		这个没有取出来的原因是jenkinsfile中内容单引号的问题，改为双引号

![1657614074875](../../.vuepress/public/images/1657614074875.png)







​		重新运行流水线--

![1657614113318](../../.vuepress/public/images/1657614113318.png)



这次我们的变量就拿到了，如果我们需要使用jenkins的变量的话，就使用双引号的方式

![1657614190632](../../.vuepress/public/images/1657614190632.png)







​		其实我们为了这个发送邮件--我们需要配置俩处，一个是全局的，一个是流水线的

​			注意使用jenkins的变量的时候使用双引号包内容

![1657614433605](../../.vuepress/public/images/1657614433605.png)





​		到现在我们的后台的微服务项目就都部署成功了，及流水线和邮件服务，接下来我们需要来部署我们的俩个前端的项目







https://www.bilibili.com/video/BV13Q4y1C7hS?p=124&spm_id_from=pageDriver&vd_source=243ad3a9b323313aa1441e5dd414a4ef



















































