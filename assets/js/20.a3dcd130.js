(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{4318:function(t,a,s){t.exports=s.p+"assets/img/image-20220106222158008.257c29fc.png"},4319:function(t,a,s){t.exports=s.p+"assets/img/image-20220106222335899.0ae9aff1.png"},4320:function(t,a,s){t.exports=s.p+"assets/img/image-20220106222446726.0b4c3b95.png"},4321:function(t,a,s){t.exports=s.p+"assets/img/image-20220106222541408.6da7d7d3.png"},4322:function(t,a,s){t.exports=s.p+"assets/img/image-20220106222702225.8c1235d8.png"},4323:function(t,a,s){t.exports=s.p+"assets/img/image-20220106222932999.b0f777be.png"},4324:function(t,a,s){t.exports=s.p+"assets/img/image-20220106223157425.7f9a0819.png"},4325:function(t,a,s){t.exports=s.p+"assets/img/image-20220106223331684.6372eee6.png"},4326:function(t,a,s){t.exports=s.p+"assets/img/image-20220106223626975.e7b8b49f.png"},4327:function(t,a,s){t.exports=s.p+"assets/img/image-20220106224115224.92d686a8.png"},4328:function(t,a,s){t.exports=s.p+"assets/img/image-20220106224534750.db7919c1.png"},4329:function(t,a,s){t.exports=s.p+"assets/img/image-20220106224657994.6cf76fc3.png"},4330:function(t,a,s){t.exports=s.p+"assets/img/image-20220106225058581.f329e237.png"},4331:function(t,a,s){t.exports=s.p+"assets/img/image-20220106225426750.d4ba1e9c.png"},4332:function(t,a,s){t.exports=s.p+"assets/img/image-20220106225647481.6a73253e.png"},4333:function(t,a,s){t.exports=s.p+"assets/img/image-20220106225758088.fcbf18c9.png"},4334:function(t,a,s){t.exports=s.p+"assets/img/image-20220106230001751.27a1ecf1.png"},4335:function(t,a,s){t.exports=s.p+"assets/img/image-20220106230127728.e89ae84b.png"},4336:function(t,a,s){t.exports=s.p+"assets/img/image-20220106230407787.a137b801.png"},4337:function(t,a,s){t.exports=s.p+"assets/img/image-20220106230542353.9caccb67.png"},4338:function(t,a,s){t.exports=s.p+"assets/img/image-20220106230643274.28e1b272.png"},4339:function(t,a,s){t.exports=s.p+"assets/img/image-20220106230727539.13420ec4.png"},4340:function(t,a,s){t.exports=s.p+"assets/img/image-20220106230838712.684e87d4.png"},4341:function(t,a,s){t.exports=s.p+"assets/img/image-20220106230918991.6eee0013.png"},4342:function(t,a,s){t.exports=s.p+"assets/img/image-20220106231237751.984f0ede.png"},4343:function(t,a,s){t.exports=s.p+"assets/img/image-20220107004351129.1558a2ec.png"},4344:function(t,a,s){t.exports=s.p+"assets/img/image-20220107004500198.73e4fd8e.png"},4345:function(t,a,s){t.exports=s.p+"assets/img/image-20220107004613488.8fdfbfd2.png"},4346:function(t,a,s){t.exports=s.p+"assets/img/image-20220107005058612.aaa623cf.png"},4347:function(t,a,s){t.exports=s.p+"assets/img/image-20220107005354678.3abf455b.png"},4348:function(t,a,s){t.exports=s.p+"assets/img/image-20220107005521583.066046ef.png"},4349:function(t,a,s){t.exports=s.p+"assets/img/image-20220107005830219.d0efb462.png"},4350:function(t,a,s){t.exports=s.p+"assets/img/image-20220107010315845.071a9ea1.png"},4351:function(t,a,s){t.exports=s.p+"assets/img/image-20220107010901854.9d22347c.png"},4352:function(t,a,s){t.exports=s.p+"assets/img/image-20220107011302049.38ec450b.png"},4353:function(t,a,s){t.exports=s.p+"assets/img/image-20220107011444735.7ace2c34.png"},4354:function(t,a,s){t.exports=s.p+"assets/img/image-20220107011530346.e6afca41.png"},4355:function(t,a,s){t.exports=s.p+"assets/img/image-20220107011830041.6163b82b.png"},9478:function(t,a,s){"use strict";s.r(a);var e=s(5),i=Object(e.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"_7-jenkins实现集群架构代码自动部署与回滚"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-jenkins实现集群架构代码自动部署与回滚"}},[t._v("#")]),t._v(" 7.jenkins实现集群架构代码自动部署与回滚")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[t._v("## 1、让项目实现支持tag版本的上线\n")])])]),e("p",[t._v("​\t\t由于之前上线方式是直接获取最新代码，那么会造成后期回退变得困难，那如果采用tag方式，比如第一次上线v1.1，第二次上线v1.2，如果上线v1.2出现问题，那么就可以快速回退至上一个版本v1.1")]),t._v(" "),e("h2",{attrs:{id:"_2、实现tag版本上线的方式思路"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2、实现tag版本上线的方式思路"}},[t._v("#")]),t._v(" 2、实现tag版本上线的方式思路")]),t._v(" "),e("p",[t._v("​\t\t1、开发如果需要发布新版本，必须将当前的版本打上一个标签。")]),t._v(" "),e("p",[t._v("​\t\t2、jenkins需要让其脚本支持传参，比如用户传递v1.1则拉取项目的v1.1标签")]),t._v(" "),e("h2",{attrs:{id:"_3、实战jenkins部署tag版本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3、实战jenkins部署tag版本"}},[t._v("#")]),t._v(" 3、实战jenkins部署tag版本")]),t._v(" "),e("p",[t._v("​\t1、首先安装Git Parameter插件，然后配置jenkins的参数化构建，让用户在构建的时候选择对应的版本")]),t._v(" "),e("p",[t._v("​\t我们先选择几种参数方式查看一下效果：")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4318),alt:"image-20220106222158008"}})]),t._v(" "),e("p",[t._v("选项参数：")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4319),alt:"image-20220106222335899"}})]),t._v(" "),e("p",[t._v("我们试一下这俩个脚本：")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4320),alt:"image-20220106222446726"}})]),t._v(" "),e("p",[t._v("立即构建--变为Build with Parameter")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4321),alt:"image-20220106222541408"}})]),t._v(" "),e("p",[t._v("​\t我们输入个参数--然后选择一个参数")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4322),alt:"image-20220106222702225"}})]),t._v(" "),e("p",[t._v("然后点击开始构建--我们看一下输出的结果是什么--是v1.5就是输入的内容")]),t._v(" "),e("p",[t._v("​\t选项参数就是输入的选项")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4323),alt:"image-20220106222932999"}})]),t._v(" "),e("h2",{attrs:{id:"_4、安装插件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4、安装插件"}},[t._v("#")]),t._v(" 4、安装插件")]),t._v(" "),e("p",[t._v("​\t搜索插件--然后安装git Parameter")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4324),alt:"image-20220106223157425"}})]),t._v(" "),e("p",[t._v("​")]),t._v(" "),e("p",[t._v("​\t\t安装过程：安装完成圆点是蓝色的不需要重启jenkins")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4325),alt:"image-20220106223331684"}})]),t._v(" "),e("p",[t._v("​\t我们把之前的参数构建删除掉，重新选择一下参数化构建过程")]),t._v(" "),e("p",[t._v("​\t\t现在安装了插件-我们就可以选择git Parameter了")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4326),alt:"image-20220106223626975"}})]),t._v(" "),e("p",[t._v("​\t输入的name--就是变量")]),t._v(" "),e("p",[t._v("​\tDescription：描述信息")]),t._v(" "),e("p",[t._v("​\tParameter Type：选择tag标签")]),t._v(" "),e("p",[t._v("​\tDefault Value ：选择分支")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4327),alt:"image-20220106224115224"}})]),t._v(" "),e("p",[t._v("​\t\t注意这个源码管理中需要修改")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4328),alt:"image-20220106224534750"}})]),t._v(" "),e("p",[t._v("​\t改为${git_version}---与参数名称一致")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4329),alt:"image-20220106224657994"}})]),t._v(" "),e("h2",{attrs:{id:"_5、修改脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5、修改脚本"}},[t._v("#")]),t._v(" 5、修改脚本")]),t._v(" "),e("p",[t._v("​\t\t因为我们需要传入参数--而且脚本中需要使用参数--所以我们需要修改脚本")]),t._v(" "),e("p",[t._v("copy一下旧脚本生成一个新的脚本--然后编辑脚本")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4330),alt:"image-20220106225058581"}})]),t._v(" "),e("p",[t._v("​\t加入tag版本参数")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4331),alt:"image-20220106225426750"}})]),t._v(" "),e("p",[t._v("脚本还可以优化一下-把时间戳和tag版本参数合并一下")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4332),alt:"image-20220106225647481"}})]),t._v(" "),e("p",[t._v("​\t设置构建的执行脚本：")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4333),alt:"image-20220106225758088"}})]),t._v(" "),e("p",[t._v("​\t点击Build with Parameter 选择你需要构建的tag版本--现在是空的")]),t._v(" "),e("p",[t._v("​\t因为在gitlab上就没有tag标签")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4334),alt:"image-20220106230001751"}})]),t._v(" "),e("p",[t._v("我们加一下tag： v1.1"),e("img",{attrs:{src:s(4335),alt:"image-20220106230127728"}})]),t._v(" "),e("p",[t._v("然后我们编辑一下代码-再次打个标签v1.2，提交")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4336),alt:"image-20220106230407787"}})]),t._v(" "),e("p",[t._v("现在我们刷新一下jenkins：可以选择tag标签了")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4337),alt:"image-20220106230542353"}})]),t._v(" "),e("p",[t._v("选择v1.3开始构建")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4338),alt:"image-20220106230643274"}})]),t._v(" "),e("p",[t._v("刷新项目--构建v1.3成功")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4339),alt:"image-20220106230727539"}})]),t._v(" "),e("p",[t._v("现在我们又想部署v1.2了")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4340),alt:"image-20220106230838712"}})]),t._v(" "),e("p",[t._v("V1.2构建成功--现在就完全实现了版本tag控制的功能")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4341),alt:"image-20220106230918991"}})]),t._v(" "),e("p",[t._v("现在有个问题：就是我们点击构建一次就会生成一个文件夹")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4342),alt:"image-20220106231237751"}})]),t._v(" "),e("h2",{attrs:{id:"_6、版本回退"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6、版本回退"}},[t._v("#")]),t._v(" 6、版本回退")]),t._v(" "),e("p",[t._v("回退如何处理：")]),t._v(" "),e("p",[t._v("​\t\t直接在web集群服务主机上，进行软连接删除和重新建立")]),t._v(" "),e("p",[t._v("​\t\t我们希望是在构建的时候可以选择-选择是部署还是回退的选项进行构建")]),t._v(" "),e("p",[t._v("我们在参数构建--增加一个 "),e("strong",[t._v("选项参数")]),t._v(" 构建")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4343),alt:"image-20220107004351129"}})]),t._v(" "),e("p",[t._v("编辑内容：")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4344),alt:"image-20220107004500198"}})]),t._v(" "),e("p",[t._v("脚本该如何接收呢？我们来修改一下脚本")]),t._v(" "),e("p",[t._v("​\tcopy一下发布tag的脚本为新的rollback脚本，然后编辑")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4345),alt:"image-20220107004613488"}})]),t._v(" "),e("p",[t._v("我们在脚本中加入一个函数 back--这个函数用于回退的功能")]),t._v(" "),e("p",[t._v("​\t\t然后我们对可选变量deploy_env进行判断 如果是 deploy字符串 就执行deploy函数")]),t._v(" "),e("p",[t._v("​\t\t如果是rollback 就执行back函数")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4346),alt:"image-20220107005058612"}})]),t._v(" "),e("p",[t._v("​")]),t._v(" "),e("p",[t._v("先保存--试试-在构建中设置执行的脚本")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4347),alt:"image-20220107005354678"}})]),t._v(" "),e("p",[t._v("先部署一下测试一下：")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4348),alt:"image-20220107005521583"}})]),t._v(" "),e("p",[t._v("构建失败--原因是脚本elif 最后得有个then;\t\t然后重新构建成功")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4349),alt:"image-20220107005830219"}})]),t._v(" "),e("p",[t._v("我们先做个查询文件的测试--查询 /code文件夹下 的 深度1级 的类型文件夹，名称为web-*-v1.1的文件夹")]),t._v(" "),e("p",[t._v("​\t基本可以精确定位到文件夹")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4350),alt:"image-20220107010315845"}})]),t._v(" "),e("p",[t._v("编辑脚本： 将查询到的回退版本 赋值给变量back_file,")]),t._v(" "),e("p",[t._v("​\t\t\t\t\t然后删除原先的web文件夹")]),t._v(" "),e("p",[t._v("​\t\t\t\t\t建立软连接到回滚的文件夹上")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4351),alt:"image-20220107010901854"}})]),t._v(" "),e("p",[t._v("选择回退--开始构建")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4352),alt:"image-20220107011302049"}})]),t._v(" "),e("p",[t._v("查看控制台：")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4353),alt:"image-20220107011444735"}})]),t._v(" "),e("p",[t._v("成功回退：这个回退是基于原先的文件夹进行的软连接切换，并没有重新copy代码进行构建")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4354),alt:"image-20220107011530346"}})]),t._v(" "),e("h2",{attrs:{id:"_7、重复构建的问题-就是一直点击构建"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7、重复构建的问题-就是一直点击构建"}},[t._v("#")]),t._v(" 7、重复构建的问题--就是一直点击构建")]),t._v(" "),e("p",[t._v("比如v1.1构建多次--那么这个项目的代码相当于被获取了多次--导致很多重复的文件夹")]),t._v(" "),e("p",[t._v("​\t\t我们肯定是不希望他能够重复执行")]),t._v(" "),e("p",[e("img",{attrs:{src:s(4355),alt:"image-20220107011830041"}})])])}),[],!1,null,null,null);a.default=i.exports}}]);