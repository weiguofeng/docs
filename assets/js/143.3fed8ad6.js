(window.webpackJsonp=window.webpackJsonp||[]).push([[143],{7175:function(s,t,a){s.exports=a.p+"assets/img/1655425529071.8bf09243.png"},7176:function(s,t,a){s.exports=a.p+"assets/img/1655425631053.6210f456.png"},7177:function(s,t,a){s.exports=a.p+"assets/img/1655425772253.8538d0ab.png"},7178:function(s,t,a){s.exports=a.p+"assets/img/1655425804040.8eb2f7a8.png"},7179:function(s,t,a){s.exports=a.p+"assets/img/1655425963995.8a8adde1.png"},7180:function(s,t,a){s.exports=a.p+"assets/img/1655426052807.dd451dac.png"},7181:function(s,t,a){s.exports=a.p+"assets/img/1655426086454.b19b692a.png"},7182:function(s,t,a){s.exports=a.p+"assets/img/1655426166158.e111b847.png"},7183:function(s,t,a){s.exports=a.p+"assets/img/1655426244447.74923bbf.png"},7184:function(s,t,a){s.exports=a.p+"assets/img/1655426356964.a88240b6.png"},7185:function(s,t,a){s.exports=a.p+"assets/img/1655426646038.00138ffd.png"},7186:function(s,t,a){s.exports=a.p+"assets/img/1655427052483.ebecd65b.png"},7187:function(s,t,a){s.exports=a.p+"assets/img/1655427312711.83ceb66b.png"},7188:function(s,t,a){s.exports=a.p+"assets/img/1655427548664.9bd0a135.png"},7189:function(s,t,a){s.exports=a.p+"assets/img/1655427773633.c99121ca.png"},7190:function(s,t,a){s.exports=a.p+"assets/img/1655427997121.095896fd.png"},7191:function(s,t,a){s.exports=a.p+"assets/img/1655428082257.ce87b3c7.png"},7192:function(s,t,a){s.exports=a.p+"assets/img/1655428123767.69f778a0.png"},8823:function(s,t,a){"use strict";a.r(t);var e=a(5),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"_29-kubernetes应用部署实战-java微服务上云-重新修改dockerfile"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_29-kubernetes应用部署实战-java微服务上云-重新修改dockerfile"}},[s._v("#")]),s._v(" 29.kubernetes应用部署实战-Java微服务上云-重新修改Dockerfile")]),s._v(" "),e("p",[s._v("​\t\t我们现在已经将镜像推送到阿里云的个人镜像仓库了")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7175),alt:"1655425529071"}})]),s._v(" "),e("p",[s._v("​\t接下来我们的思路还是和之前一样，因为已经部署过了中间件-数据层，现在我们需要部署微服务，整个部署的架构是自下而上的过程")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7176),alt:"1655425631053"}})]),s._v(" "),e("p",[s._v("​\t按这么个顺序，我们先来部署 监控中心")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7177),alt:"1655425772253"}})]),s._v(" "),e("p",[s._v("​\t登录kubesphere")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7178),alt:"1655425804040"}})]),s._v(" "),e("p",[s._v("​\t因为从工作负载中部署的应用，他的服务名称会有一些其他的字符标识，所以为了我们更清晰的名称，我们接下来都使用服务进行部署")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7179),alt:"1655425963995"}})]),s._v(" "),e("h4",{attrs:{id:"部署java微服务"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署java微服务"}},[s._v("#")]),s._v(" 部署Java微服务")]),s._v(" "),e("p",[s._v("​\t\t选择无状态服务")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7180),alt:"1655426052807"}})]),s._v(" "),e("p",[s._v("​\t填写微服务基本信息")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7181),alt:"1655426086454"}})]),s._v(" "),e("p",[s._v("​\t输入阿里云的镜像地址--然后默认端口使用8080，然后同步主机时区")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7182),alt:"1655426166158"}})]),s._v(" "),e("p",[s._v("​\t挂载存储这里我们的每个微服务没有什么需要挂载的--直接下一步")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7183),alt:"1655426244447"}})]),s._v(" "),e("p",[s._v("​\t\t而且也不允许他外网访问--我们整个项目唯一需要外网访问的就是前端项目--然后创建")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7184),alt:"1655426356964"}})]),s._v(" "),e("p",[s._v("​\t已经创建好了，列表存在该服务")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7185),alt:"1655426646038"}})]),s._v(" "),e("h4",{attrs:{id:"部署规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署规则"}},[s._v("#")]),s._v(" 部署规则：")]),s._v(" "),e("p",[s._v("​\t"),e("strong",[s._v("这里注意")]),s._v('：因为我们在dockerfile目前是写死的每个应用 启动都会去获取Nacos中的"应用名称-激活环境标识.yml"这个文件，所以部署每个微服务都一定要小心，要注意这些配置文件是否正确。')]),s._v(" "),e("ul",[e("li",[s._v('应用一启动会获取到 "应用名-激活的环境标识.yml"')]),s._v(" "),e("li",[s._v("每次部署应用的时候，需要提前修改nacos线上配置，确认好每个中间件的连接地址是否正确")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(7186),alt:"1655427052483"}})]),s._v(" "),e("p",[s._v("我们看一下刚刚部署的应用日志信息，我们发现原因是Nacos的问题连接不上，而且使用的还是本地Nacos并没有使用线上环境")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7187),alt:"1655427312711"}})]),s._v(" "),e("p",[s._v("​")]),s._v(" "),e("p",[s._v("​\t我们查看代码配置文件发现--原因是因为注册中心配了一个Nacos的地址，配置中心配了一个Nacos地址")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7188),alt:"1655427548664"}})]),s._v(" "),e("p",[s._v("​\t其实也可以这样配，只写一个server-addr")]),s._v(" "),e("p",[s._v("​\t解决方案：其实这个问题我们应该在docker启动命令上就改为使用线上的Nacos，因为我们的dockerfile启动命令的参数上没有精确的 将nacos的配置覆盖掉，导致的还是使用的之前的配置")]),s._v(" "),e("p",[s._v("​")]),s._v(" "),e("p",[s._v("​\t我们在启动命令参数上精确指定一下Nacos的配置中心地址，和注册中心地址")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7189),alt:"1655427773633"}})]),s._v(" "),e("p",[s._v("​\t更新后的dockerfile文件")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("FROM openjdk:8-jdk\nLABEL "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("maintainer")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("leifengyang\n\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#docker run -e PARAMS="--server.port 9090"')]),s._v("\nENV "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PARAMS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--server.port=8080 --spring.profiles.active=prod --spring.cloud.nacos.discovery.server-addr=his-nacos.his:8848 --spring.cloud.nacos.config.server-addr=his-nacos.his:8848 --spring.cloud.nacos.config.namespace=prod --spring.cloud.nacos.config.file-extension=yml"')]),s._v("\nRUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Asia/Shanghai'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/etc/timezone\n\nCOPY target/*.jar /app.jar\nEXPOSE "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\nENTRYPOINT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/bin/sh"')]),s._v(","),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),s._v(","),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"java -Dfile.encoding=utf8 -Djava.security.egd=file:/dev/./urandom -jar app.jar '),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${PARAMS}")]),s._v('"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("​\t那么我们就需要重新打包了和推送镜像了")]),s._v(" "),e("p",[s._v("​\t我们先进入到存放项目镜像文件夹--然后找到dockerfile，修改dockerfile")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7190),alt:"1655427997121"}})]),s._v(" "),e("p",[s._v("​\t重新构建镜像")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7191),alt:"1655428082257"}})]),s._v(" "),e("p",[s._v("​\t重新推送镜像--到阿里云仓库")]),s._v(" "),e("p",[e("img",{attrs:{src:a(7192),alt:"1655428123767"}})]),s._v(" "),e("p",[s._v("​\t\t每个微服务都应该这样做，因为基本都是使用到了nacos")]),s._v(" "),e("p",[s._v("https://www.bilibili.com/video/BV13Q4y1C7hS?p=97&spm_id_from=pageDriver&vd_source=243ad3a9b323313aa1441e5dd414a4ef")])])}),[],!1,null,null,null);t.default=n.exports}}]);